<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>looselips benchmark</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      line-height: 1.6;
    }

    h1 {
      color: #f8fafc;
      margin-bottom: 0.3rem;
      font-size: 1.8rem;
    }

    h2 {
      color: #f1f5f9;
      font-size: 1.1rem;
      margin-bottom: 0.6rem;
    }

    .sub {
      color: #94a3b8;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    /* -- Model scorecards -- */

    .scorecards {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .scorecard {
      background: #1e293b;
      border-radius: 8px;
      padding: 0.8rem 1.2rem;
      min-width: 140px;
    }

    .scorecard .model-name {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 0.2rem;
      word-break: break-all;
    }

    .scorecard .pct {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .scorecard .detail {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    /* -- Crosstab tables -- */

    .crosstabs {
      margin-bottom: 1.5rem;
    }

    .crosstab-section {
      margin-bottom: 1rem;
    }

    .crosstab-section h3 {
      font-size: 0.85rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.3rem;
    }

    table.crosstab {
      border-collapse: collapse;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    table.crosstab th,
    table.crosstab td {
      padding: 0.3rem 0.7rem;
      text-align: right;
      border-bottom: 1px solid #334155;
    }

    table.crosstab th {
      background: #1e293b;
      color: #94a3b8;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: static;
    }

    table.crosstab td:first-child {
      text-align: left;
      color: #cbd5e1;
    }

    .accuracy-good { color: #22c55e; }
    .accuracy-mid  { color: #eab308; }
    .accuracy-bad  { color: #ef4444; }

    /* -- Main results table -- */

    table.results {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    table.results th {
      background: #1e293b;
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.6rem 0.8rem;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    table.results td {
      padding: 0.5rem 0.8rem;
      border-bottom: 1px solid #1e293b;
    }

    /* Testcase header row */
    tr.tc-header {
      cursor: pointer;
      transition: background 0.1s;
    }

    tr.tc-header:hover {
      background: #1e293b;
    }

    .tc-title {
      font-weight: 500;
      color: #f1f5f9;
    }

    /* Matcher sub-rows */
    tr.matcher-row td {
      padding-top: 0.3rem;
      padding-bottom: 0.3rem;
      font-size: 0.85rem;
    }

    .matcher-name {
      color: #94a3b8;
      padding-left: 1.5rem;
    }

    .expect-match    { color: #94a3b8; }
    .cell-pass       { color: #dcfce7; font-weight: 600; background: #14532d; }
    .cell-fail       { color: #fecaca; font-weight: 600; background: #7f1d1d; }
    .cell-empty      { color: #334155; }
    .cell-elapsed    { font-weight: 400; font-size: 0.7rem; color: #64748b; }

    .expand-arrow {
      display: inline-block;
      transition: transform 0.15s;
      margin-right: 0.3rem;
      color: #475569;
      font-size: 0.75rem;
    }

    .expand-arrow.open {
      transform: rotate(90deg);
    }

    /* Detail panel */
    .detail-row {
      display: none;
    }

    .detail-row.open {
      display: table-row;
    }

    .detail-cell {
      background: #1e293b;
      padding: 1rem;
      border-bottom: 2px solid #334155;
    }

    .detail-section {
      margin-bottom: 1rem;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section h4 {
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
    }

    .msg {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.8rem;
      padding: 0.3rem 0;
      line-height: 1.5;
    }

    .msg-role {
      font-weight: 600;
      text-transform: uppercase;
    }

    .msg-role-user { color: #60a5fa; }
    .msg-role-assistant { color: #a78bfa; }

    .msg-text {
      color: #cbd5e1;
      white-space: pre-wrap;
      margin-left: 1rem;
      margin-bottom: 0.5rem;
    }

    .reasoning-group {
      margin-bottom: 0.6rem;
    }

    .reasoning-group-title {
      font-weight: 600;
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 0.3rem;
    }

    .reasoning-box {
      background: #0f172a;
      border-radius: 4px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.4rem;
    }

    .reasoning-label {
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
    }

    .reasoning-text {
      font-size: 0.8rem;
      color: #cbd5e1;
      font-style: italic;
    }

    .reasoning-meta {
      font-size: 0.7rem;
      color: #64748b;
      margin-top: 0.2rem;
    }

    /* -- Legend and footer -- */

    .legend {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.8rem;
      color: #94a3b8;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .footer {
      text-align: center;
      color: #475569;
      font-size: 0.75rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #1e293b;
    }
  </style>
</head>
<body>

<h1>looselips benchmark</h1>
<p class="sub">Generated {{ now }}</p>

<!-- Model scorecards -->
<div class="scorecards">
  {% for model in report.models %}
    {% set correct, total = report.model_score(model) %}
    {% set pct = (correct / total * 100) | int if total else 0 %}
    <div class="scorecard">
      <div class="model-name">{{ model }}</div>
      <div class="pct" style="color: {{ '#22c55e' if pct >= 80 else '#eab308' if pct >= 60 else '#ef4444' }}">{{ pct }}%</div>
      <div class="detail">{{ correct }}/{{ total }} correct</div>
    </div>
  {% endfor %}
</div>

<!-- Per-matcher crosstab -->
<div class="crosstabs">
  {% for matcher in report.matchers %}
    <div class="crosstab-section">
      <h3>{{ matcher }}</h3>
      <table class="crosstab">
        <thead>
          <tr>
            <th>Model</th>
            <th>TP</th>
            <th>TN</th>
            <th>FP</th>
            <th>FN</th>
            <th>Accuracy</th>
          </tr>
        </thead>
        <tbody>
          {% for model in report.models %}
            {% set ct = report.crosstab(model, matcher) %}
            {% set ct_total = ct.TP + ct.TN + ct.FP + ct.FN %}
            {% set ct_ok = ct.TP + ct.TN %}
            {% set ct_pct = (ct_ok / ct_total * 100) | int if ct_total else 0 %}
            <tr>
              <td>{{ model }}</td>
              <td>{{ ct.TP }}</td>
              <td>{{ ct.TN }}</td>
              <td>{{ ct.FP }}</td>
              <td>{{ ct.FN }}</td>
              <td class="{{ 'accuracy-good' if ct_pct >= 80 else 'accuracy-mid' if ct_pct >= 60 else 'accuracy-bad' }}">{{ ct_pct }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}
</div>

<!-- Legend -->
<div class="legend">
  <div class="legend-item"><span class="cell-pass">PASS</span> -- model result matches expectation</div>
  <div class="legend-item"><span class="cell-fail">FAIL</span> -- model result contradicts expectation</div>
  <div class="legend-item"><span class="cell-empty">--</span> -- not yet run</div>
</div>

<!-- Main results table -->
<table class="results">
  <thead>
    <tr>
      <th>Testcase</th>
      <th>Matcher</th>
      <th>Expect</th>
      {% for model in report.models %}
        <th>{{ model }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in report.rows %}
      {# Testcase header row #}
      <tr class="tc-header" onclick="toggleDetail({{ loop.index0 }})">
        <td class="tc-title" colspan="{{ 3 + report.models | length }}">
          <span class="expand-arrow" id="arrow-{{ loop.index0 }}">&#9654;</span>
          {{ row.title }}
        </td>
      </tr>
      {# Matcher sub-rows #}
      {% for matcher, expected in row.expectations.items() %}
        <tr class="matcher-row">
          <td></td>
          <td class="matcher-name">{{ matcher }}</td>
          <td class="expect-match">{{ "match" if expected else "no match" }}</td>
          {% for model in report.models %}
            {% set cell = row.cells.get(model, {}).get(matcher) %}
            {% if cell is not none %}
              {% set ok = (cell.found == expected) %}
              <td class="{{ 'cell-pass' if ok else 'cell-fail' }}">{{ "PASS" if ok else "FAIL" }} <span class="cell-elapsed">{{ '%.1f' | format(cell.elapsed) }}s</span></td>
            {% else %}
              <td class="cell-empty">--</td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endfor %}
      {# Detail panel #}
      <tr class="detail-row" id="detail-{{ loop.index0 }}">
        <td class="detail-cell" colspan="{{ 3 + report.models | length }}">

          <div class="detail-section">
            <h4>Conversation ({{ row.messages | length }} messages)</h4>
            {% for m in row.messages %}
              <div class="msg">
                <span class="msg-role msg-role-{{ m.role }}">{{ m.role }}:</span>
                <div class="msg-text">{{ m.text }}</div>
              </div>
            {% endfor %}
          </div>

          <div class="detail-section">
            <h4>LLM Reasoning</h4>
            {% for matcher in row.expectations %}
              <div class="reasoning-group">
                <div class="reasoning-group-title">{{ matcher }}</div>
                {% for model in report.models %}
                  {% set cell = row.cells.get(model, {}).get(matcher) %}
                  {% if cell is not none %}
                    {% set ok = (cell.found == row.expectations[matcher]) %}
                    <div class="reasoning-box">
                      <div class="reasoning-label {{ 'cell-pass' if ok else 'cell-fail' }}">
                        {{ model }} -- expected={{ row.expectations[matcher] }}, got={{ cell.found }}
                      </div>
                      <div class="reasoning-text">{{ cell.reasoning }}</div>
                      <div class="reasoning-meta">{{ '%.1f' | format(cell.elapsed) }}s</div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}
          </div>

        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<div class="footer">looselips benchmark</div>

<script>
function toggleDetail(idx) {
  var row = document.getElementById('detail-' + idx);
  var arrow = document.getElementById('arrow-' + idx);
  if (row.classList.contains('open')) {
    row.classList.remove('open');
    arrow.classList.remove('open');
  } else {
    row.classList.add('open');
    arrow.classList.add('open');
  }
}
</script>

</body>
</html>
