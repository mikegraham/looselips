<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>looselips benchmark</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      line-height: 1.6;
    }

    h1 { color: #f8fafc; margin-bottom: 0.3rem; font-size: 1.8rem; }
    .sub { color: #94a3b8; margin-bottom: 1.5rem; font-size: 0.9rem; }

    /* -- Scorecards -- */
    .scorecards { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }

    .scorecard {
      background: #1e293b;
      border-radius: 8px;
      padding: 0.8rem 1.2rem;
      min-width: 120px;
    }

    .scorecard .model-name {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 0.2rem;
      word-break: break-all;
    }

    .scorecard .pct { font-size: 1.8rem; font-weight: 700; }
    .scorecard .detail { font-size: 0.75rem; color: #94a3b8; }

    /* -- Crosstab -- */
    table.crosstab { border-collapse: collapse; margin-bottom: 1.5rem; font-size: 0.8rem; }

    table.crosstab th,
    table.crosstab td {
      padding: 0.3rem 0.7rem;
      text-align: right;
      border-bottom: 1px solid #334155;
    }

    table.crosstab th {
      background: #1e293b;
      color: #94a3b8;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    table.crosstab td:first-child { text-align: left; color: #cbd5e1; }

    .accuracy-good { color: #22c55e; }
    .accuracy-mid  { color: #eab308; }
    .accuracy-bad  { color: #ef4444; }

    /* -- Results table -- */
    table.results {
      border-collapse: collapse;
      border-spacing: 0;
      margin-bottom: 1rem;
    }

    table.results th {
      background: #1e293b;
      color: #94a3b8;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.5rem 0.4rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }

    table.results th.col-matcher,
    table.results th.col-expect { text-align: left; }

    table.results td {
      padding: 0.4rem;
      border: none;
    }

    .col-matcher { min-width: 8rem; }
    .col-expect  { min-width: 5rem; }

    /* Testcase header row */
    tr.tc-header { cursor: pointer; transition: background 0.1s; }
    tr.tc-header:hover { background: #1e293b; }

    .tc-title {
      font-weight: 500;
      color: #f1f5f9;
      padding: 0.6rem 0.4rem 0.2rem;
    }

    /* Matcher sub-rows */
    tr.matcher-row td { font-size: 0.85rem; }
    .matcher-name { color: #94a3b8; padding-left: 1.5rem; }
    .expect-col { color: #94a3b8; }

    /* PASS/FAIL cells */
    td.cell { padding: 0; border: none; }

    .cell-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1;
      height: 2.8rem;
      line-height: 1.2;
    }

    .cell-pass .cell-inner { color: #dcfce7; font-weight: 600; background: #14532d; }
    .cell-fail .cell-inner { color: #fecaca; font-weight: 600; background: #7f1d1d; }

    td.cell-empty { color: #334155; text-align: center; padding: 0; }

    .cell-verdict { font-size: 0.7rem; }
    .cell-elapsed { font-weight: 400; font-size: 0.55rem; opacity: 0.5; }

    .expand-arrow {
      display: inline-block;
      transition: transform 0.15s;
      margin-right: 0.3rem;
      color: #475569;
      font-size: 0.75rem;
    }

    .expand-arrow.open { transform: rotate(90deg); }

    /* -- Detail panel -- */
    .detail-row { display: none; }
    .detail-row.open { display: table-row; }

    .detail-cell {
      background: #1e293b;
      padding: 1rem;
      border-bottom: 2px solid #334155;
    }

    .detail-section { margin-bottom: 1rem; }
    .detail-section:last-child { margin-bottom: 0; }

    .detail-section h4 {
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
    }

    .msg {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.8rem;
      padding: 0.3rem 0;
      line-height: 1.5;
    }

    .msg-role { font-weight: 600; text-transform: uppercase; }
    .msg-role-user { color: #60a5fa; }
    .msg-role-assistant { color: #a78bfa; }

    .msg-text {
      color: #cbd5e1;
      white-space: pre-wrap;
      margin-left: 1rem;
      margin-bottom: 0.5rem;
    }

    .reasoning-group { margin-bottom: 0.6rem; }

    .reasoning-group-title {
      font-weight: 600;
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 0.3rem;
    }

    .reasoning-box {
      background: #0f172a;
      border-radius: 4px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.4rem;
    }

    .reasoning-label { font-weight: 600; font-size: 0.8rem; margin-bottom: 0.2rem; }
    .reasoning-text { font-size: 0.8rem; color: #cbd5e1; font-style: italic; }
    .reasoning-meta { font-size: 0.7rem; color: #64748b; margin-top: 0.2rem; }

    /* -- Legend and footer -- */
    .legend {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.8rem;
      color: #94a3b8;
      flex-wrap: wrap;
    }

    .legend-item { display: flex; align-items: center; gap: 0.3rem; }

    .footer {
      text-align: center;
      color: #475569;
      font-size: 0.75rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #1e293b;
    }
  </style>
</head>
<body>

<h1>looselips benchmark</h1>
<p class="sub">Generated {{ now }}</p>

<div class="scorecards">
{% for model in report.models %}
  {% set correct, total = report.model_score(model) %}
  {% set pct = (correct / total * 100) | int if total else 0 %}
  <div class="scorecard">
    <div class="model-name">{{ model | short_model }}</div>
    <div class="pct" style="color: {{ '#22c55e' if pct >= 80 else '#eab308' if pct >= 60 else '#ef4444' }}">{{ pct }}%</div>
    <div class="detail">{{ correct }}/{{ total }} correct</div>
  </div>
{% endfor %}
</div>

<table class="crosstab">
  <thead>
    <tr>
      <th>Model</th><th>TP</th><th>TN</th><th>FP</th><th>FN</th><th>Accuracy</th><th>Recall</th>
    </tr>
  </thead>
  <tbody>
  {% for model in report.models %}
    {% set ct = report.crosstab(model) %}
    {% set ct_total = ct.TP + ct.TN + ct.FP + ct.FN %}
    {% set ct_ok = ct.TP + ct.TN %}
    {% set ct_pct = (ct_ok / ct_total * 100) | int if ct_total else 0 %}
    {% set ct_pos = ct.TP + ct.FN %}
    {% set ct_recall = (ct.TP / ct_pos * 100) | int if ct_pos else 0 %}
    <tr>
      <td>{{ model | short_model }}</td>
      <td>{{ ct.TP }}</td><td>{{ ct.TN }}</td><td>{{ ct.FP }}</td><td>{{ ct.FN }}</td>
      <td class="{{ 'accuracy-good' if ct_pct >= 80 else 'accuracy-mid' if ct_pct >= 60 else 'accuracy-bad' }}">{{ ct_pct }}%</td>
      <td class="{{ 'accuracy-good' if ct_recall >= 80 else 'accuracy-mid' if ct_recall >= 60 else 'accuracy-bad' }}">{{ ct_recall }}%</td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<div class="legend">
  <div class="legend-item"><span class="cell-pass cell-verdict">PASS</span> -- model matches expectation</div>
  <div class="legend-item"><span class="cell-fail cell-verdict">FAIL</span> -- model contradicts expectation</div>
  <div class="legend-item"><span class="cell-empty">--</span> -- not yet run</div>
</div>

<table class="results">
  <thead>
    <tr>
      <th class="col-matcher">Matcher</th>
      <th class="col-expect">Expect</th>
    {% for model in report.models %}
      <th>{{ model | short_model }}</th>
    {% endfor %}
    </tr>
  </thead>
  <tbody>
  {% for row in report.rows %}
    <tr class="tc-header" onclick="toggleDetail({{ loop.index0 }})">
      <td class="tc-title" colspan="{{ 2 + report.models | length }}">
        <span class="expand-arrow" id="arrow-{{ loop.index0 }}">&#9654;</span>
        {{ row.title }}
      </td>
    </tr>
    {% for matcher, expected in row.expectations.items() %}
    <tr class="matcher-row">
      <td class="matcher-name">{{ matcher }}</td>
      <td class="expect-col">{{ "match" if expected else "no match" }}</td>
    {% for model in report.models %}
      {% set cell = row.cells.get(model, {}).get(matcher) %}
      {% if cell is not none %}
      {% set ok = (cell.found == expected) %}
      <td class="cell {{ 'cell-pass' if ok else 'cell-fail' }}"><div class="cell-inner">
        <span class="cell-verdict">{{ "PASS" if ok else "FAIL" }}</span>
        <span class="cell-elapsed">{{ '%.1f' | format(cell.elapsed) }}s</span>
      </div></td>
      {% else %}
      <td class="cell cell-empty">--</td>
      {% endif %}
    {% endfor %}
    </tr>
    {% endfor %}
    <tr class="detail-row" id="detail-{{ loop.index0 }}">
      <td class="detail-cell" colspan="{{ 2 + report.models | length }}">
        <div class="detail-section">
          <h4>Conversation ({{ row.messages | length }} messages)</h4>
        {% for m in row.messages %}
          <div class="msg">
            <span class="msg-role msg-role-{{ m.role }}">{{ m.role }}:</span>
            <div class="msg-text">{{ m.text }}</div>
          </div>
        {% endfor %}
        </div>
        <div class="detail-section">
          <h4>LLM Reasoning</h4>
        {% for matcher in row.expectations %}
          <div class="reasoning-group">
            <div class="reasoning-group-title">{{ matcher }}</div>
          {% for model in report.models %}
            {% set cell = row.cells.get(model, {}).get(matcher) %}
            {% if cell is not none %}
            {% set ok = (cell.found == row.expectations[matcher]) %}
            <div class="reasoning-box">
              <div class="reasoning-label {{ 'cell-pass' if ok else 'cell-fail' }}">
                {{ model | short_model }} -- expected={{ row.expectations[matcher] }}, got={{ cell.found }}
              </div>
              <div class="reasoning-text">{{ cell.reasoning }}</div>
              <div class="reasoning-meta">{{ '%.1f' | format(cell.elapsed) }}s</div>
            </div>
            {% endif %}
          {% endfor %}
          </div>
        {% endfor %}
        </div>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<div class="footer">looselips benchmark</div>

<script>
function toggleDetail(idx) {
  var row = document.getElementById('detail-' + idx);
  var arrow = document.getElementById('arrow-' + idx);
  row.classList.toggle('open');
  arrow.classList.toggle('open');
}
</script>

</body>
</html>
